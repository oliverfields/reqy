#!/usr/bin/python
import Action
from requirements.Utility import report_error
import getopt
import sys
import os

def usage(mode='default'):
	executable_name = os.path.basename(sys.argv[0])

	usage_message = {
		'build': ' <directory>',
		'dependency': '(dep) [to|from] <document|package|requirement>',
		'init': ' ',
		'new': ' [glossary|package|requirement(req)|stakeholder] <name>',
		'report': ' <name>',
	}

	if mode == 'default':
		modes = ''
		for key, message in usage_message.items():
			modes = '%s|%s' % (key, modes)

		modes = modes.lstrip('|')
		modes = modes.rstrip('|')
		print 'Usage: %s [%s] <actions>' % (executable_name, modes)
	else:
		print 'Usage: %s %s%s' % (executable_name, mode, usage_message[mode])

def new_mode():
	if len(sys.argv) == 4:
		actions = ['glossary', 'package', 'requirement', 'stakeholder']
		is_valid_action = False
		action = sys.argv[2]

		if action == 'req':
			action = 'requirement'

		for valid_action in actions:
			if action == valid_action:
				is_valid_action = True

		if is_valid_action:
			Action.new_item(action, sys.argv[3])
		else:
			usage('new')
			report_error(1, 'Action "%s" not recognized' % action)
	else:
		usage('new')
		report_error(1, 'Wrong number of arguments')

def dependency_mode():
	valid_arguments = False

	if len(sys.argv) == 4:
		direction = sys.argv[2]
		item = sys.argv[3]

		if direction == 'to' or direction == 'from':
			valid_arguments = True
		else:
			report_error(1, 'Unknown dependency direction "%s", must be either "to" or "from"' % direction)
	else:
		usage('dependency')
		report_error(1, 'Wrong number of arguments')

	if valid_arguments:
		Action.list_dependency(direction, item)
	else:
		usage('dependency')
		sys.exit(1)

def build_mode():
	if len(sys.argv) == 3:
		Action.build_artifacts(sys.argv[2])
	else:
		usage('build')
		report_error(1, 'Wrong number of arguments')

def report_mode():
	if len(sys.argv) == 3:
		Action.run_report(sys.argv[2])
	else:
		usage('report')
		report_error(1, 'Wrong number of arguments')

def init_mode():
	if len(sys.argv) == 2:
		Action.init_repo()
	else:
		usage('init')
		report_error(1, 'Wrong number of arguments')

try:
	mode = sys.argv[1]
except Exception:
	usage()
	sys.exit(0)

options, remainder = getopt.getopt(sys.argv[2:], 'o:v', ['output=', 'verbose', 'version=', ])

if mode == "dependency" or mode == "dep":
	dependency_mode()
elif mode == "new":
	new_mode()
elif mode == "build":
	build_mode()
elif mode == "report":
	report_mode()
elif mode == "init":
	init_mode()
else:
	usage()
	report_error(1, 'Unknown mode "%s"' % mode)
